# KarukuResize GUI リファクタリング計画書

## 現状分析レポート

### 作業完了状況（2025-06-29時点）

#### 完了したフェーズ
1. **Phase 1**: バグ修正と安定性向上
   - エラーハンドリングの改善
   - 入力検証の強化
   - スレッドセーフティの実装

2. **Phase 2**: 基本的なUX改善
   - ドラッグ&ドロップ機能
   - 進捗トラッキング
   - 設定の永続化
   - エラーダイアログの改善

3. **Phase 3**: 高度な機能の実装
   - 画像プレビューウィジェット
   - プリセットマネージャー
   - 履歴管理システム
   - 統計ビューワー

4. **Phase 3.5**: GUI統合
   - メニューバーの追加
   - プリセット機能の統合
   - 新規タブ（プレビュー、履歴、統計）の追加
   - 履歴記録の統合
   - LazyTabManagerによる遅延読み込み

### 現在のコードベースの問題点

#### 1. コードメトリクス
- **ファイルサイズ**: `resize_images_gui.py` - 2,547行（巨大すぎる）
- **クラスの複雑性**: Appクラスに56個のメソッド（多すぎる）
- **全体のコード行数**: 12,562行（19ファイル）

#### 2. アーキテクチャの問題

##### a) 単一責任の原則（SRP）違反
Appクラスが以下のすべてを担当：
- UI構築とレイアウト
- ビジネスロジック（画像処理）
- イベントハンドリング
- 状態管理
- ファイルI/O
- スレッド管理
- エラーハンドリング
- ロギング
- 設定管理

##### b) 密結合
- UI要素とビジネスロジックが密接に結合
- テストが困難（UIなしでロジックをテストできない）
- 再利用性が低い

##### c) コードの重複
- 似たようなUI構築パターンが繰り返されている
- エラーハンドリングの重複
- バリデーションロジックの重複

#### 3. 保守性の問題
- 長大なメソッド（一部のメソッドは100行以上）
- 深いネスト（if文やtry-except文の多重ネスト）
- マジックナンバーや文字列の散在
- 不明瞭な変数名（`current_row`の使い回しなど）

#### 4. パフォーマンスの懸念
- すべてのUIコンポーネントが起動時に作成される
- メモリ使用量の最適化不足
- 不要な再描画の可能性

## リファクタリング戦略

### フェーズ1: アーキテクチャの再設計

#### 1.1 MVVMパターンの導入
```
Model層:
- ImageProcessor: 画像処理ロジック
- SettingsModel: 設定データモデル
- HistoryModel: 履歴データモデル

ViewModel層:
- ResizeViewModel: リサイズタブのビジネスロジック
- PreviewViewModel: プレビュータブのビジネスロジック
- HistoryViewModel: 履歴タブのビジネスロジック
- StatisticsViewModel: 統計タブのビジネスロジック

View層:
- MainWindow: メインウィンドウフレーム
- ResizeTabView: リサイズタブUI
- PreviewTabView: プレビュータブUI
- HistoryTabView: 履歴タブUI
- StatisticsTabView: 統計タブUI
```

#### 1.2 依存性注入（DI）の実装
- DIコンテナの作成
- インターフェースの定義
- モックオブジェクトによるテスト容易性の向上

### フェーズ2: コード分割とモジュール化

#### 2.1 新しいモジュール構造
```
karukuresize/
├── gui/
│   ├── __init__.py
│   ├── main_window.py
│   ├── views/
│   │   ├── __init__.py
│   │   ├── resize_tab.py
│   │   ├── preview_tab.py
│   │   ├── history_tab.py
│   │   └── statistics_tab.py
│   ├── view_models/
│   │   ├── __init__.py
│   │   ├── resize_view_model.py
│   │   ├── preview_view_model.py
│   │   ├── history_view_model.py
│   │   └── statistics_view_model.py
│   ├── widgets/
│   │   ├── __init__.py
│   │   ├── file_selector.py
│   │   ├── progress_widget.py
│   │   └── log_widget.py
│   └── utils/
│       ├── __init__.py
│       ├── ui_helpers.py
│       └── constants.py
├── models/
│   ├── __init__.py
│   ├── image_processor.py
│   ├── settings_model.py
│   └── history_model.py
└── services/
    ├── __init__.py
    ├── image_service.py
    ├── preset_service.py
    └── history_service.py
```

#### 2.2 各モジュールの責任範囲

##### MainWindow（200行以下）
- ウィンドウの初期化
- タブの管理
- メニューバーの管理
- グローバルイベントの処理

##### ResizeTabView（300行以下）
- リサイズタブのUI構築
- UIイベントのバインディング
- ViewModelへのデータ受け渡し

##### ResizeViewModel（200行以下）
- リサイズ設定の管理
- バリデーションロジック
- 画像処理の実行管理

### フェーズ3: 具体的なリファクタリング手順

#### 3.1 準備段階
1. 包括的なテストスイートの作成
2. 現在の動作を保証するE2Eテストの実装
3. リファクタリング用のブランチ作成

#### 3.2 段階的な移行

##### ステップ1: ユーティリティの抽出
- UI構築ヘルパー関数の抽出
- 定数の外部化
- 共通ウィジェットのコンポーネント化

##### ステップ2: ViewModelの作成
- ビジネスロジックの抽出
- 状態管理の分離
- イベントハンドラの移動

##### ステップ3: Viewの分割
- タブごとにViewクラスを作成
- UI構築ロジックの移動
- イベントバインディングの整理

##### ステップ4: Modelの抽出
- データモデルの定義
- ビジネスロジックの純粋関数化
- サービス層の実装

#### 3.3 リファクタリング後の期待効果
- **コード行数**: 各ファイル300行以下
- **テスタビリティ**: 90%以上のカバレッジ可能
- **保守性**: 明確な責任分離により変更が容易
- **拡張性**: 新機能追加が簡単
- **パフォーマンス**: 必要な部分のみ読み込み

### フェーズ4: パフォーマンス最適化

#### 4.1 メモリ使用量の削減
- 不要なウィジェットの遅延生成
- 画像キャッシュの実装
- メモリリークの検出と修正

#### 4.2 レスポンシブ性の向上
- 重い処理の非同期化
- プログレッシブレンダリング
- デバウンス/スロットリングの実装

### フェーズ5: 品質保証

#### 5.1 コード品質の向上
- 型ヒントの完全化
- Docstringの充実
- リンターの設定強化

#### 5.2 テストの充実
- 単体テストの作成
- 統合テストの実装
- パフォーマンステストの追加

## 実装優先順位

### 高優先度（必須）
1. ViewModelの抽出（ビジネスロジックの分離）
2. Viewの分割（UIコードの整理）
3. 定数とユーティリティの外部化

### 中優先度（推奨）
1. サービス層の実装
2. DIコンテナの導入
3. テストスイートの充実

### 低優先度（理想的）
1. パフォーマンス最適化
2. 追加的なリファクタリング
3. ドキュメントの充実

## リスクと対策

### リスク
1. **機能の破壊**: 既存機能が動作しなくなる
   - 対策: 包括的なテストの事前作成

2. **パフォーマンス低下**: 過度な抽象化による速度低下
   - 対策: パフォーマンステストの実施

3. **開発期間の長期化**: 予想以上の複雑性
   - 対策: 段階的な移行とマイルストーンの設定

## 次回作業時のチェックリスト

### 作業再開時の確認事項
- [ ] 現在のコードがビルド・実行可能か確認
- [ ] テストがすべてパスするか確認
- [ ] バックアップの作成
- [ ] リファクタリング用ブランチの作成

### 最初に着手すべきタスク
1. **ユーティリティ関数の抽出**
   - UI構築ヘルパーの作成
   - 定数クラスの作成
   - 共通バリデーション関数の抽出

2. **ResizeViewModelの作成**
   - リサイズロジックの抽出
   - 状態管理の分離
   - イベントハンドラの移動

3. **ResizeTabViewの分離**
   - UI構築コードの移動
   - ViewModelとの接続
   - イベントバインディングの整理

## 参考資料

### 設計パターン
- MVVM (Model-View-ViewModel)
- 依存性注入 (Dependency Injection)
- リポジトリパターン
- ファクトリーパターン

### ベストプラクティス
- SOLID原則
- DRY (Don't Repeat Yourself)
- KISS (Keep It Simple, Stupid)
- YAGNI (You Aren't Gonna Need It)

### 推奨ツール
- pytest: テストフレームワーク
- mypy: 型チェッカー
- black: コードフォーマッター
- ruff: リンター

---

このドキュメントは2025年6月29日時点の状況を反映しています。
作業再開時は、このドキュメントを参照して継続してください。