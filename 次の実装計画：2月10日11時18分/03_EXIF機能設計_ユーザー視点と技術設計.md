# EXIF機能設計（ユーザー視点 + 技術設計）

## 1. 要求の要約
今回の会話で確定した追加要求：
1. GUIに品質指定を追加（5刻み、最低値定義あり）
2. GUIに出力形式指定を追加
3. GUIにドライランを追加
4. GUIに詳細ログ切替を追加
5. EXIFの扱いを3モード化
   - keep: 元EXIFをそのまま付与
   - edit: 編集して付与
   - remove: EXIFを付与しない
6. EXIF関連のユーザーフレンドリーな補助機能（GPS削除、差分確認など）

## 2. EXIFでユーザーが実際に困るポイント
1. 位置情報（GPS）の漏えい
2. 著作権情報の欠落
3. SNS/変換後にEXIFが意図せず消える
4. 設定が複雑で使い分けできない

## 3. 調査で確認した技術要点（Pillow）

### 3.1 基本API
- EXIF取得: `Image.getexif()`
- 保存時付与: `Image.save(..., exif=exif_bytes)`
- タグ定数: `PIL.ExifTags`

### 3.2 形式別の留意点
1. JPEG
   - EXIF付与との相性がよい
2. PNG
   - EXIFの運用が不安定になりやすい場面がある
   - 読み取り時は `load()` 後で `info` に反映されるケースがある
3. WebP / AVIF
   - Pillowビルド/実行環境に依存
   - 実行時に `PIL.features.check("webp")`, `check("avif")` で判定が必要

### 3.3 品質パラメータの扱い
- JPEG: 一般に 95 までが実用上の上限推奨
- WebP/AVIF: 0-100系で扱える
- PNG: quality ではなく圧縮レベル中心

## 4. ユーザーフレンドリー機能の候補評価

### 4.1 高価値・低リスク（優先）
1. EXIFモード `keep/remove`
2. GPSのみ削除
3. 保存後の反映結果表示（何件書けたか）
4. 4つのプリセット
   - 完全保持
   - 完全削除
   - プライバシー重視（GPS削除）
   - 著作権付与

### 4.2 中価値・中リスク（次段階）
1. `edit` モード
2. 編集項目を限定
   - `Artist`
   - `Copyright`
   - `UserComment`
   - `DateTimeOriginal`
3. 保存前差分プレビュー

### 4.3 低優先（後回し）
1. 任意EXIFタグの自由編集
2. メーカー独自タグの高度編集

## 5. 推奨仕様（現実的な最適案）

### 5.1 品質
- UI値: `5..100`, `5`刻み
- 形式別内部適用
  - JPEG: `min(ui_quality, 95)`
  - WebP/AVIF: `ui_quality`そのまま
  - PNG: `compress_level`に変換

### 5.2 EXIFモード
- `keep`: 元EXIFをそのまま引き継ぎ
- `remove`: EXIFを付与せず保存
- `edit`: 指定項目のみ編集して保存
- 共通オプション: `GPS削除`

### 5.3 UI設計
1. 「出力設定」パネル
   - 出力形式
   - 品質（5刻み）
   - ドライラン
   - 詳細ログ
2. 「EXIF設定」パネル
   - モード切替
   - GPS削除
   - edit時のみ編集フィールド表示
3. 「結果表示」
   - 保存後にEXIF反映件数/未適用件数

## 6. フォーマット差異への設計対応
1. 対応不可フォーマットでは、EXIFオプションを自動的に制限
2. 未対応タグはスキップし、処理全体は継続
3. スキップ理由をログまたは結果ダイアログで提示

## 7. 個人開発前提での依存戦略
1. 初期は Pillowのみで実装
2. 互換性問題が出た場合のみ補助ライブラリ検討
3. 依存追加は最小限に留める

## 8. 採用しない方がよい方針（今回時点）
1. 初回リリースから高度な任意タグ編集を入れる
2. CLI/GUIを同時大改修する
3. ドキュメント主導で実装し、現行コード実態を無視する

## 9. 結論
- EXIF機能は追加価値が高い。
- ただし、最適解は「段階導入」。
- 最初に出すべきは、`keep/remove + GPS削除 + 保存後検証`。
- `edit` は限定項目で次段階導入する。

