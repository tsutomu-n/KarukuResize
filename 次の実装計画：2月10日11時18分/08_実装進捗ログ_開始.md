# 実装進捗ログ（開始）

## 実施日時
- 2026-02-10 11:xx

## 実施内容（Phase 1着手）
1. 画像保存処理をGUI本体から分離し、`src/karuku_resizer/image_save_pipeline.py` を新規追加。
2. `src/karuku_resizer/gui_app.py` に保存設定UIを追加。
   - 出力形式（自動/JPEG/PNG/WEBP/AVIF）
   - 品質（5〜100、5刻み）
   - EXIF（保持/編集/削除）
   - GPS削除
   - ドライラン
   - 詳細ログ
3. 単体保存・一括保存を新パイプラインへ接続。
4. 設定永続化キーを追加し、復元処理を更新。

## 技術的な修正ポイント
1. 品質値は `normalize_quality()` で 5刻み正規化。
2. 形式判定は `resolve_output_format()` で実画像ベースに決定。
3. WebP/AVIF可否は `features.check()` + `Image.registered_extensions()` で判定。
4. EXIFは keep/edit/remove + GPS削除を実装。

## 検証
1. `python -m py_compile src/karuku_resizer/image_save_pipeline.py src/karuku_resizer/gui_app.py`
2. 構文エラーなしを確認。
3. `uv run pytest -q tests/test_image_save_pipeline.py`
4. 保存パイプラインのテスト 7件すべて成功（quality/format/EXIF keep-edit-remove/dry-run）。

## 未着手
1. 保存前EXIF差分プレビュー

## 追加改善（内省反映）
1. EXIF edit を実装（Artist/Copyright/UserComment/DateTimeOriginal）
2. EXIF付与失敗時のフォールバック保存を実装（メタデータなしで保存継続）
3. EXIFステータス表示を詳細化（フォールバック/未付与理由/編集項目数）
4. 読み込み時に `ImageOps.exif_transpose` を適用し、Orientation由来の不整合を抑制
5. 一括保存時の同名衝突回避（`_resized`, `_resized_1`, ...）

## 追加改善（UI二層化）
1. GUIを「基本操作 + 詳細設定（折りたたみ）」の2層構成へ変更。
2. 保存設定の1行サマリーを追加（形式 / 品質 / EXIF / GPS削除 / ドライラン）。
3. 詳細設定の開閉トグルを追加し、開閉状態を `details_expanded` として設定ファイルへ永続化。
4. 品質変更時にプレビュー情報（見積もりサイズ）を即時再描画する挙動を追加。

## 追加改善（EXIF差分プレビュー）
1. `image_save_pipeline` に保存前のEXIF反映計画を返す `preview_exif_plan()` と `ExifPreview` を追加。
2. GUI詳細設定に `EXIF差分` ボタンを追加し、選択中画像に対する差分プレビューをダイアログ表示。
3. プレビュー表示内容:
   - 元EXIFタグ数 / 元GPS有無
   - モード別の保存予定（保持/編集/削除）
   - GPS削除予定
   - 編集項目（撮影者・著作権・撮影日時・コメント）
4. 一括保存時は画像ごとの差異注意を注記表示。

## 現時点の状態
1. CLI相当の保存関連機能（形式/品質/dry-run/verbose/EXIF keep-edit-remove）はGUIで操作可能。
2. GUIの構文検証は `py_compile` で通過済み。
3. GUIのヘッドレス起動検証は、`xvfb-run` 上で `customtkinter.CTkButton` 生成時に `xcb` アサーションで停止する環境依存制約あり（ロジック検証はテストで担保）。
4. `tests/test_image_save_pipeline.py` は 9 件すべて成功（EXIF差分プレビュー計算を含む）。
