# 03 現行アーキテクチャと実装状態

## 分かったこと（詳細）

### A. GUI層 (`src/karuku_resizer/gui_app.py`)
1. 詳細設定パネルが実装済み（折りたたみ表示）。
2. 設定サマリー表示があり、現在値を文字列で確認可能。
3. 保存導線は単体保存と一括保存を持つ。
4. EXIF差分プレビューが利用可能。
5. 設定は `karuku_settings.json` へ保存・復元される。

### B. 保存パイプライン (`src/karuku_resizer/image_save_pipeline.py`)
1. `SaveOptions`:
   - output_format
   - quality
   - dry_run
   - exif_mode
   - remove_gps
   - exif_edit
   - verbose
2. `save_image()`:
   - 形式別保存オプション生成
   - EXIF組み立て
   - 保存実行
   - EXIF保存失敗時フォールバック保存
3. `normalize_quality()`:
   - 5〜100に丸め、5刻み化

### C. CLI層 (`src/karuku_resizer/resize_core.py`)
1. 引数:
   - `-q/--quality`
   - `-f/--format`
   - `--dry-run`
   - `-v/--verbose`
2. GUIの要求との機能整合を取りやすい構造。

## 技術要素
1. 透過画像→JPEG/AVIF保存時はRGB化処理あり。
2. AVIFは環境依存のため、利用可否判定が必要。
3. EXIF編集項目は現状4項目で固定実装。

## 決定事項
1. 保存ロジックは `image_save_pipeline.py` を単一の真実源として拡張する。
2. GUI側には表示制御と入力収集責務を持たせる。

## 未解決点
1. EXIF以外（XMP/ICC等）を今回範囲に含めるかは最終未確定。
2. GUI不具合の再現シナリオを最短で固定する必要がある。

## 検証方法
1. 単体保存で `SaveResult` の各フラグ（exif_attached等）を確認。
2. 一括保存で件数集計（成功/失敗/フォールバック）を確認。
3. 設定再起動復元テスト。

## 関連ファイル/URL
1. `src/karuku_resizer/gui_app.py`
2. `src/karuku_resizer/image_save_pipeline.py`
3. `src/karuku_resizer/resize_core.py`
4. `tests/test_image_save_pipeline.py`
