# 実装計画: 簡易モード / プロモード

## 1. 実装目標
1. 事務員ユーザーが迷わず使える簡易導線を作る。
2. プロユーザー向けに詳細メタデータ編集を提供する。
3. 既存の保存ロジックを壊さず、機能追加を段階導入する。

## 2. 完成イメージ

### 2.1 簡易モード（初期）
- 見える設定:
  1. 出力形式
  2. 品質（5刻み）
  3. EXIF（保持/削除）
  4. GPS削除
  5. ドライラン
- 非表示:
  - 詳細ログ
  - 個別EXIF編集フィールド
  - 高度なメタデータカテゴリ

### 2.2 プロモード
- 追加表示:
  1. EXIF編集項目群
  2. EXIF差分プレビュー詳細
  3. 詳細ログ
  4. 将来拡張項目

## 3. 実装方針

### 3.1 GUIレイヤ（`gui_app.py`）
1. 新規状態変数:
   - `ui_mode_var`: `simple` / `pro`
2. 表示制御:
   - 設定パネルを簡易/プロで出し分ける。
3. 設定永続化:
   - `ui_mode` を `karuku_settings.json` へ保存・復元。
4. 実行導線:
   - `_build_save_options()` は共通化し、モード差を内部で吸収する。

### 3.2 保存パイプライン（`image_save_pipeline.py`）
1. `ExifEditValues` の段階拡張:
   - 第1段階項目を追加可能な構造へ変更。
2. 編集適用関数の拡張:
   - `_apply_exif_edits()` を項目ごとの変換関数で分離。
3. 結果構造:
   - `SaveResult.edited_fields` を活用し、UI表示精度を上げる。

### 3.3 テスト（`tests/test_image_save_pipeline.py`）
1. 追加項目の書き込み検証。
2. 入力値妥当性（日時、GPSなど）検証。
3. フォーマット差の保存結果検証。
4. EXIF失敗時フォールバック検証の維持。

## 4. 実装タスク分解

### Phase 1: モード基盤
1. `ui_mode_var` 追加
2. モード切替UI追加
3. 設定保存/復元対応
4. 既存詳細設定の表示条件整理

### Phase 2: 簡易モード確定
1. 簡易表示項目のみ残す
2. 既存処理の回帰確認
3. 一括保存フローの確認

### Phase 3: プロモード拡張
1. メタデータ編集フィールドのカテゴリ化
2. 差分プレビュー表示の明確化
3. 詳細ログ表示制御

### Phase 4: パイプライン拡張
1. `ExifEditValues` 拡張
2. `_apply_exif_edits()` 分離
3. `SaveResult` 表示整合の調整

### Phase 5: テストと仕上げ
1. 単体テスト追加・更新
2. GUI手動テスト
3. `.exe` 実機検証（Windows）

## 5. データモデル案（第1段階）
- 現行:
  - artist
  - copyright_text
  - user_comment
  - datetime_original
- 追加候補（第1段階）:
  - title
  - comment
  - keywords
  - gps_latitude
  - gps_longitude
  - gps_altitude

注記:
- 実際のタグ変換は Pillow で扱える形式へ落とし込む。
- 未対応タグは「無視 + 結果表示」で処理継続する。

## 6. UI仕様（最小）
1. モード切替は常時上部表示。
2. モード切替で入力値は保持する。
3. プロモード項目は折りたたみ表示可。
4. EXIF差分はプロモードで強調表示する。

## 7. 失敗を防ぐ実装ルール
1. `save_image()` の呼び出しシグネチャを不用意に破壊しない。
2. `SaveOptions` に追加した項目は default を必ず設定する。
3. 既存キーの後方互換を維持する。
4. UI表示条件と保存処理条件を一致させる。

## 8. 完了判定
1. 簡易モードで既存保存機能がすべて動作する。
2. プロモードで編集項目が保存結果へ反映される。
3. 設定復元でモード/値が崩れない。
4. テストが通り、手動確認で主要導線が完了する。
